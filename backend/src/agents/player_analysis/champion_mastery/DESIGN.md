# ChampionMasteryAgent Design Document

## Overview
ChampionMasteryAgent analyzes a player's mastery of a single champion across all available match history, providing deep insights into learning progression, position specialization, and version adaptation.

## Purpose
- **Deep mastery evaluation**: Quantify how well a player has mastered a specific champion
- **Learning curve tracking**: Analyze performance improvement over time
- **Position specialization**: Identify optimal roles for the champion
- **Version adaptation**: Track performance across different meta environments
- **Skill ceiling assessment**: Evaluate current skill level vs theoretical maximum

## Input Data
- **Source**: Player-pack files (pack_*.json) from all available patches
- **Required fields**:
  - `by_cr[]`: Champion-role statistics (games, wins, total_kills, total_deaths, etc.)
  - `metadata.patch`: Patch version
  - `metadata.generated_at`: Timestamp
- **Champion filter**: Extract all data for a specific champion_id across all patches and roles

## Analysis Components

### 1. Overall Mastery Metrics
- **Total games played**: Across all patches and roles
- **Overall win rate**: With Wilson 95% CI
- **Version coverage**: Number of patches where champion was played
- **Play rate**: % of total games on this champion
- **Consistency score**: CI width as proxy for performance stability

### 2. Learning Curve Analysis
Segment games chronologically into phases:
- **Early phase** (games 1-30): Initial learning
- **Mid phase** (games 31-100): Skill development
- **Late phase** (games 101+): Mastery phase

For each phase, calculate:
- Win rate and CI
- Average KDA
- Performance trend (improving/stable/declining)

### 3. Position Specialization
For each role where champion was played:
- Games played and win rate
- KDA comparison across roles
- Statistical significance of role differences
- Optimal role identification

### 4. Version Adaptation
- Performance by patch (win rate over time)
- Shock impact correlation (does player adapt to meta changes?)
- Version stability (CI width variation across patches)
- Meta alignment (performance in strong vs weak patches for the champion)

### 5. Match Quality Analysis
- Average KDA across all games
- Damage share (if available)
- Kill participation (if available)
- CS efficiency (if available)
- Objective participation

### 6. Core Build Patterns
- Most common item builds (if data available)
- Win rate by build path
- Build adaptation across patches

## Output Structure

### Quantitative Analysis (JSON)
```json
{
  "champion_id": 157,
  "champion_name": "Yasuo",
  "summary": {
    "total_games": 175,
    "overall_winrate": 0.583,
    "ci_lower": 0.512,
    "ci_upper": 0.651,
    "version_coverage": 9,
    "play_rate": 0.527,
    "mastery_score": "A-",
    "consistency_score": 0.92
  },
  "learning_curve": {
    "early": {"games": 30, "winrate": 0.521, "kda": 2.3},
    "mid": {"games": 70, "winrate": 0.598, "kda": 2.8},
    "late": {"games": 75, "winrate": 0.612, "kda": 3.1}
  },
  "position_analysis": {
    "MIDDLE": {"games": 137, "winrate": 0.676, "kda": 3.2, "rank": "A"},
    "TOP": {"games": 38, "winrate": 0.542, "kda": 2.6, "rank": "B"}
  },
  "version_adaptation": {
    "patches_played": [...],
    "performance_trend": "improving",
    "meta_correlation": 0.68
  }
}
```

### Narrative Report (Markdown)
- **2000-3000 word detailed report** generated by Sonnet 4.5
- Sections:
  1. Mastery Overview (300-400 words)
  2. Learning Journey Analysis (500-700 words)
  3. Position Specialization (400-500 words)
  4. Version Adaptation Performance (400-500 words)
  5. Strengths and Areas for Improvement (400-500 words)
  6. Recommendations for Continued Growth (200-300 words)

## Mastery Score Calculation

### Scoring Components
1. **Volume Score** (0-30 points):
   - 0-20 games: 10 points
   - 21-50 games: 20 points
   - 51+ games: 30 points

2. **Performance Score** (0-40 points):
   - Win rate vs 50% baseline
   - Scaled by CI width (tighter CI = higher confidence)

3. **Consistency Score** (0-15 points):
   - Based on CI width
   - Narrow CI (<10% width) = 15 points
   - Wide CI (>20% width) = 5 points

4. **Adaptation Score** (0-15 points):
   - Version coverage (more patches = better)
   - Performance stability across patches

### Grade Mapping
- **S**: 90-100 points (Elite mastery)
- **A**: 80-89 points (Advanced mastery)
- **B**: 70-79 points (Proficient)
- **C**: 60-69 points (Competent)
- **D**: 50-59 points (Developing)
- **F**: <50 points (Beginner)

## Technical Implementation

### Files
1. **tools.py**: Data extraction and analysis functions
   - `extract_champion_data()`: Filter all packs for specific champion
   - `analyze_learning_curve()`: Chronological performance analysis
   - `analyze_position_specialization()`: Role-based comparison
   - `analyze_version_adaptation()`: Patch-level performance
   - `calculate_mastery_score()`: Overall mastery scoring
   - `format_analysis_for_prompt()`: Prepare data for LLM

2. **prompts.py**: LLM prompt engineering
   - `SYSTEM_PROMPT`: Guide Sonnet to generate 2000-3000 word report
   - `build_narrative_prompt()`: Construct user prompt with analysis data

3. **agent.py**: Main agent orchestration
   - `ChampionMasteryAgent.run()`: Execute full analysis pipeline

4. **__init__.py**: Module exports

### Dependencies
- Reuse `src/core/statistical_utils.py` for Wilson CI calculations
- Standard libraries: json, pathlib, typing, defaultdict

## Usage Example

```python
from src.agents.player_analysis import ChampionMasteryAgent

agent = ChampionMasteryAgent(model="sonnet")

analysis, report = agent.run(
    champion_id=157,  # Yasuo
    packs_dir="test_agents/player_coach/packs",
    output_dir="output/champion_mastery"
)

print(f"Mastery Score: {analysis['summary']['mastery_score']}")
print(f"Total Games: {analysis['summary']['total_games']}")
print(f"\n{report}")
```

## Quality Standards
- Minimum 10 games required for analysis
- Statistical significance testing for role comparisons
- Evidence-based mastery scoring
- Comprehensive 2000-3000 word narrative report
- JSON output for programmatic access

## Future Enhancements
- Matchup analysis (performance vs specific enemy champions)
- Build path optimization recommendations
- Comparison to champion mains at higher ranks
- Skill ceiling estimation based on theoretical maximum performance
